---
- name: Ensure Pi-Hole directory exists
  file:
    path: /etc/pihole
    # owner and group handled by Pi-Hole
    mode: '0755'
    state: directory
  tags: pihole

- name: Install/Update Pi-Hole configuration
  template:
    src: setupVars.conf.j2
    dest: /etc/pihole/setupVars.conf
    # owner and group handled by Pi-Hole
    mode: '0644'
  tags: pihole

- name: Download Pi-Hole installer
  get_url:
    url: https://install.pi-hole.net
    dest: /tmp/pihole-installer.sh
  tags: pihole

- name: Run Pi-Hole installer
  command: bash /tmp/pihole-installer.sh --unattended
  tags: pihole

- name: Cleanup Pi-Hole installer
  file:
    path: /tmp/pihole-installer.sh
    state: absent
  tags:
    - pihole
    - cleanup

- name: Ensure system is using Pi-Hole (self) for DNS
  lineinfile:
    path: /etc/dhcpcd.conf
    regexp: '^(\s*)static domain_name_servers='
    line: '\1static domain_name_servers=127.0.0.1 ::1'
    backrefs: yes
  register: pihole_dhcpcd_config
  tags:
    - pihole
    - network

- name: Restart dhcpcd to load new configuration changes
  systemd:
    name: dhcpcd
    state: restarted
    daemon_reload: yes
  when: pihole_dhcpcd_config.changed
  tags:
    - pihole
    - network

- include_tasks: sync.yml
  when: pihole_sync
  tags:
    - pihole
    - sync

- name: Flush old Pi-Hole query logs
  command: /usr/local/bin/pihole -f
  when: pihole_flush_logs
  tags:
    - pihole
    - cleanup